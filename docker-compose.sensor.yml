services:
  db:
    # Dich vu co so du lieu MySQL 8.0
    image: mysql:8.0
    container_name: flow-mysql
    env_file:
      - .env
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-tls_ids}
      MYSQL_USER: ${MYSQL_USER:-tls_user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      # Luu tru du lieu va cac script khoi tao database
      - ./mysql-data:/var/lib/mysql
      - ./mysql-init:/docker-entrypoint-initdb.d
    healthcheck:
      # Kiem tra trang thai MySQL san sang truoc khi cac service khac ket noi
      test: ["CMD-SHELL", "MYSQL_PWD=\"$MYSQL_ROOT_PASSWORD\" mysqladmin ping -h 127.0.0.1 -uroot --silent"]
      interval: 5s
      timeout: 3s
      retries: 30
    ports:
      # Mo cong MySQL de cac thanh phan ben ngoai nhu firewall controller co the ket noi
      - "${MYSQL_PUBLIC_BIND:-0.0.0.0}:${MYSQL_PUBLIC_PORT:-3306}:3306"
    networks:
      sensor_net:
        ipv4_address: ${MYSQL_IP:-172.30.0.10}
    restart: unless-stopped

  backend:
    # Dich vu xu ly logic chinh cua he thong
    build: ./backend
    container_name: flow-backend
    depends_on:
      # Chi khoi chay backend khi database da san sang
      db:
        condition: service_healthy
    env_file:
      - .env
    environment:
      DB_HOST: db
      DB_PORT: 3306
      DB_NAME: ${MYSQL_DATABASE:-tls_ids}
      DB_USER: ${MYSQL_USER:-tls_user}
      DB_PASSWORD: ${MYSQL_PASSWORD}
      REQUIRE_INGEST_HMAC: ${REQUIRE_INGEST_HMAC:-false}
      INGEST_HMAC_SECRET: ${INGEST_HMAC_SECRET:-}
      INGEST_HMAC_MAX_AGE_SEC: ${INGEST_HMAC_MAX_AGE_SEC:-120}
      AUTO_BLOCK: ${AUTO_BLOCK:-false}
    expose:
      - "8000"
    networks:
      sensor_net:
        ipv4_address: ${BACKEND_IP:-172.30.0.20}
    restart: unless-stopped

  nfstream:
    # Dich vu thu thap va trich xuat dac trung luu luong mang
    build: ./nfstream
    container_name: nfstream-sniffer
    # Su dung host mode de bat goi tin truc tiep tu card mang vat ly
    network_mode: "host"
    cap_add:
      - NET_ADMIN
      - NET_RAW
    env_file:
      - .env
    environment:
      CAPTURE_INTERFACE: ${CAPTURE_INTERFACE:-eth0}
      OUTPUT_MODE: ${CIC_OUTPUT_MODE:-url}
      # Gui du lieu flow den dich vu phan tich thoi gian thuc
      FLOW_URL: ${FLOW_URL:-http://172.30.0.30:9000/flow}
      IDLE_TIMEOUT: ${IDLE_TIMEOUT:-10}
      ACTIVE_TIMEOUT: ${ACTIVE_TIMEOUT:-300}
      FLOW_CSV_PATH: /shared/flows/flows.csv
    volumes:
      - ./shared/flows:/shared/flows
    restart: unless-stopped

  python-realtime:
    # Dich vu phan tich va phat hien xam nhap su dung Machine Learning
    build: ./python-real-time-service
    container_name: flow-rt
    depends_on:
      - backend
    env_file:
      - .env
    environment:
      BACKEND_URL: http://backend:8000
      INGEST_MODE: ${INGEST_MODE:-url}
      LISTEN_HOST: 0.0.0.0
      LISTEN_PORT: 9000
      FLOW_CSV_PATH: /shared/flows/flows.csv
      # Duong dan toi cac mo hinh MLP va Scaler da duoc huan luyen
      MLP_MODEL_PATH: /app/trained_models/mlp.h5
      AE_MODEL_PATH: /app/trained_models/mlp.h5
      SCALER_PATH: /app/trained_models/scaler.pkl
      # Nguong phan loai cho mo hinh hoc may
      MLP_THRESHOLD: ${MLP_THRESHOLD:-0.5}
      AE_THRESHOLD: ${MLP_THRESHOLD:-0.5}
      ISO_THRESHOLD: ${ISO_THRESHOLD:--0.1}
      REQUIRE_INGEST_HMAC: ${REQUIRE_INGEST_HMAC:-false}
      INGEST_HMAC_SECRET: ${INGEST_HMAC_SECRET:-}
      INGEST_HMAC_MAX_AGE_SEC: ${INGEST_HMAC_MAX_AGE_SEC:-120}
      MLP_MODEL_SHA256: ${MLP_MODEL_SHA256:-}
      AE_MODEL_SHA256: ${MLP_MODEL_SHA256:-}
      SCALER_SHA256: ${SCALER_SHA256:-}
    expose:
      - "9000"
    networks:
      sensor_net:
        ipv4_address: ${RT_IP:-172.30.0.30}
    volumes:
      - ./shared/flows:/shared/flows
      - ./python-real-time-service/trained_models:/app/trained_models:ro
    restart: unless-stopped

networks:
  # Cau hinh mang noi bo cho cac thanh phan IDS
  sensor_net:
    driver: bridge
    ipam:
      config:
        - subnet: ${SENSOR_NET_SUBNET:-172.30.0.0/24}