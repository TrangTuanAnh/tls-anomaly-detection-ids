services:
  db:
    image: mysql:8.0
    container_name: flow-mysql
    env_file:
      - .env
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-tls_ids}
      MYSQL_USER: ${MYSQL_USER:-tls_user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - ./mysql-data:/var/lib/mysql
      - ./mysql-init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "-p${MYSQL_ROOT_PASSWORD}"]
      interval: 5s
      timeout: 3s
      retries: 30
    # Chỉ MySQL được publish ra host/network (để firewall-controller connect).
    # Các service khác chỉ giao tiếp nội bộ qua Docker network.
    ports:
      - "${MYSQL_PUBLIC_BIND:-0.0.0.0}:${MYSQL_PUBLIC_PORT:-3306}:3306"
    networks:
      sensor_net:
        ipv4_address: ${MYSQL_IP:-172.30.0.10}
    restart: unless-stopped

  backend:
    build: ./backend
    container_name: flow-backend
    depends_on:
      db:
        condition: service_healthy
    env_file:
      - .env
    environment:
      DB_HOST: db
      DB_PORT: 3306
      DB_NAME: ${MYSQL_DATABASE:-tls_ids}
      DB_USER: ${MYSQL_USER:-tls_user}
      DB_PASSWORD: ${MYSQL_PASSWORD}
      REQUIRE_INGEST_HMAC: ${REQUIRE_INGEST_HMAC:-false}
      INGEST_HMAC_SECRET: ${INGEST_HMAC_SECRET:-}
      INGEST_HMAC_MAX_AGE_SEC: ${INGEST_HMAC_MAX_AGE_SEC:-120}
      AUTO_BLOCK: ${AUTO_BLOCK:-false}
    expose:
      - "8000"
    networks:
      sensor_net:
        ipv4_address: ${BACKEND_IP:-172.30.0.20}
    restart: unless-stopped

  nfstream:
    build: ./nfstream
    container_name: nfstream-sniffer
    network_mode: "host"
    cap_add:
      - NET_ADMIN
      - NET_RAW
    # easiest for sniffing in many environments:
    # privileged: true
    env_file:
      - .env
    environment:
      CAPTURE_INTERFACE: ${CAPTURE_INTERFACE:-eth0}
      # IMPORTANT: use URL mode for realtime
      # Backward-compatible env var name (from old cicflowmeter service)
      OUTPUT_MODE: ${CIC_OUTPUT_MODE:-url}
      # Host-mode container không join được Docker DNS network, nên gửi về IP cố định
      # của python-realtime trong sensor_net. (Override được bằng biến FLOW_URL.)
      FLOW_URL: ${FLOW_URL:-http://172.30.0.30:9000/flow}
      # Flow split timeouts (seconds)
      IDLE_TIMEOUT: ${IDLE_TIMEOUT:-10}
      ACTIVE_TIMEOUT: ${ACTIVE_TIMEOUT:-300}
      # keep CSV path for debugging (not used in url mode)
      FLOW_CSV_PATH: /shared/flows/flows.csv
    volumes:
      - ./shared/flows:/shared/flows
    restart: unless-stopped

  python-realtime:
    build: ./python-real-time-service
    container_name: flow-rt
    depends_on:
      - backend
    env_file:
      - .env
    environment:
      BACKEND_URL: http://backend:8000
      # Enable HTTP ingest (recommended). You can set INGEST_MODE=both to also tail CSV.
      INGEST_MODE: ${INGEST_MODE:-url}
      LISTEN_HOST: 0.0.0.0
      LISTEN_PORT: 9000

      FLOW_CSV_PATH: /shared/flows/flows.csv
      # Preferred env var name
      MLP_MODEL_PATH: /app/trained_models/mlp.h5
      # Backward-compatible env var name (older docs used AE_MODEL_PATH)
      AE_MODEL_PATH: /app/trained_models/mlp.h5
      SCALER_PATH: /app/trained_models/scaler.pkl
      # Threshold for sigmoid score (0..1). Default 0.5 for binary classifier.
      MLP_THRESHOLD: ${MLP_THRESHOLD:-0.5}
      # Backward-compatible env var name
      AE_THRESHOLD: ${MLP_THRESHOLD:-0.5}
      ISO_THRESHOLD: ${ISO_THRESHOLD:--0.1}
      REQUIRE_INGEST_HMAC: ${REQUIRE_INGEST_HMAC:-false}
      INGEST_HMAC_SECRET: ${INGEST_HMAC_SECRET:-}
      INGEST_HMAC_MAX_AGE_SEC: ${INGEST_HMAC_MAX_AGE_SEC:-120}
      MLP_MODEL_SHA256: ${MLP_MODEL_SHA256:-}
      # Backward-compatible env var name
      AE_MODEL_SHA256: ${MLP_MODEL_SHA256:-}
      SCALER_SHA256: ${SCALER_SHA256:-}
    expose:
      - "9000"
    networks:
      sensor_net:
        ipv4_address: ${RT_IP:-172.30.0.30}
    volumes:
      - ./shared/flows:/shared/flows
      - ./python-real-time-service/trained_models:/app/trained_models:ro
    restart: unless-stopped

networks:
  sensor_net:
    driver: bridge
    ipam:
      config:
        - subnet: ${SENSOR_NET_SUBNET:-172.30.0.0/24}
