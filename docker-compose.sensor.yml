services:
  db:
    image: mysql:8.0
    container_name: flow-mysql
    env_file:
      - .env
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-tls_ids}
      MYSQL_USER: ${MYSQL_USER:-tls_user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - ./mysql-data:/var/lib/mysql
      - ./mysql-init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "-p${MYSQL_ROOT_PASSWORD}"]
      interval: 5s
      timeout: 3s
      retries: 30
    restart: unless-stopped

  backend:
    build: ./backend
    container_name: flow-backend
    depends_on:
      db:
        condition: service_healthy
    env_file:
      - .env
    environment:
      DB_HOST: db
      DB_PORT: 3306
      DB_NAME: ${MYSQL_DATABASE:-tls_ids}
      DB_USER: ${MYSQL_USER:-tls_user}
      DB_PASSWORD: ${MYSQL_PASSWORD}
      REQUIRE_INGEST_HMAC: ${REQUIRE_INGEST_HMAC:-false}
      INGEST_HMAC_SECRET: ${INGEST_HMAC_SECRET:-}
      INGEST_HMAC_MAX_AGE_SEC: ${INGEST_HMAC_MAX_AGE_SEC:-120}
      AUTO_BLOCK: ${AUTO_BLOCK:-false}
    ports:
      - "8000:8000"
    restart: unless-stopped

  cicflowmeter:
    build: ./cicflowmeter
    container_name: cicflowmeter-sniffer
    network_mode: "host"
    cap_add:
      - NET_ADMIN
      - NET_RAW
    # easiest for sniffing in many environments:
    privileged: true
    env_file:
      - .env
    environment:
      CAPTURE_INTERFACE: ${CAPTURE_INTERFACE:-eth0}
      FLOW_CSV_PATH: /shared/flows/flows.csv
    volumes:
      - ./shared/flows:/shared/flows
    restart: unless-stopped

  python-realtime:
    build: ./python-real-time-service
    container_name: flow-rt
    depends_on:
      - backend
    env_file:
      - .env
    environment:
      BACKEND_URL: http://backend:8000
      FLOW_CSV_PATH: /shared/flows/flows.csv
      AE_MODEL_PATH: /app/trained_models/mlp.h5
      SCALER_PATH: /app/trained_models/scaler.pkl
      AE_THRESHOLD: ${AE_THRESHOLD:-0.05}
      ISO_THRESHOLD: ${ISO_THRESHOLD:--0.1}
      REQUIRE_INGEST_HMAC: ${REQUIRE_INGEST_HMAC:-false}
      INGEST_HMAC_SECRET: ${INGEST_HMAC_SECRET:-}
      INGEST_HMAC_MAX_AGE_SEC: ${INGEST_HMAC_MAX_AGE_SEC:-120}
      AE_MODEL_SHA256: ${AE_MODEL_SHA256:-}
      SCALER_SHA256: ${SCALER_SHA256:-}
    volumes:
      - ./shared/flows:/shared/flows
      - ./python-real-time-service/trained_models:/app/trained_models:ro
    restart: unless-stopped
